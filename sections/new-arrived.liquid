{% schema %}
{
  "name": "New Arrived",
  "settings": [
    {
      "type": "collection",
      "id": "new_collection",
      "label": "Select collection"
    },
    {
      "type": "color",
      "id": "collection_title_color",
      "label": "Collection title color",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Product title color",
      "default": "#222222"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#ff0000"
    },
    {
      "type": "checkbox",
      "id": "enable_slider",
      "label": "Enable mobile slider",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "New Arrived"
    }
  ]
}
{% endschema %}

<div class="new-arrived">
  {% if section.settings.new_collection != blank %}

    <h2 class="new-arrived-heading">New Arrived</h2>

    {% assign products = section.settings.new_collection.products | limit: 8 %}

    <div class="grid grid--4 {% if section.settings.enable_slider %}slider-enabled{% endif %}">
      {% for product in products %}
        <div class="product-card">
          {% if product.metafields.custom.new_label %}
            <span class="product-new-label">New</span>
          {% endif %}

          <a href="{{ product.url }}">
            <img 
              class="product-image"
              src="{{ product.featured_image | image_url: width: 800 }}" 
              alt="{{ product.title }}"
              loading="lazy"
            >
          </a>

          <p class="collection-title">{{ section.settings.new_collection.title }}</p>
          <h4 class="product-title">{{ product.title }}</h4>
          <p class="product-price">{{ product.price | money }}</p>

          {% assign color_option_index = nil %}
          {% for option in product.options %}
            {% if option contains 'Color' or option contains 'Colour' or option contains 'Колір' %}
              {% assign color_option_index = forloop.index0 %}
            {% endif %}
          {% endfor %}

          {% if color_option_index != nil %}
            <div class="color-variants">
              {% assign used_colors = '' %}
              {% for variant in product.variants %}
                {% assign color_value = variant.options[color_option_index] %}
                {% unless used_colors contains color_value %}
                  {% assign used_colors = used_colors | append: color_value | append: ',' %}
                  {% if variant.featured_media %}
                    <button 
                      class="color-swatch"
                      data-image="{{ variant.featured_media | image_url: width: 800 }}"
                      style="background-color: {{ color_value | downcase }};"
                      aria-label="{{ color_value }}"
                    ></button>
                  {% endif %}
                {% endunless %}
              {% endfor %}
            </div>
          {% endif %}

        </div>
      {% endfor %}
    </div>

  {% endif %}
</div>

<style>
.new-arrived-heading {
  color: {{ section.settings.collection_title_color }};
  text-align: center;
  font-size: 28px;
  font-weight: bold;
  font-family: var(--font-heading-family);
  margin-bottom: 20px;
}

.new-arrived .grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  padding: 0 20px;
}

.new-arrived .grid--4 .product-card {
  width: calc(25% - 20px);
  box-sizing: border-box;
}

.product-card img {
  width: 100%;
  height: 420px;
  object-fit: cover;
  display: block;
}

.product-card h4.product-title {
  color: {{ section.settings.product_title_color }};
  font-family: var(--font-heading-family);
  margin: 6px 0;
  line-height: 1.3;
}

.product-card p.collection-title {
  color: {{ section.settings.collection_title_color }};
  font-family: var(--font-body-family);
  margin: 6px 0;
  line-height: 1.3;
}

.product-card p.product-price {
  color: {{ section.settings.price_color }};
  font-family: var(--font-body-family);
  margin: 6px 0;
  line-height: 1.3;
}

.product-card {
  position: relative;
}

.product-new-label {
  position: absolute;
  top: 10px;
  left: 10px;
  background-color: #ff0000;
  color: #fff;
  font-size: 12px;
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 4px;
  z-index: 10;
}

.color-variants {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  justify-content: center;
}

.color-swatch {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 1px solid #ccc;
  cursor: pointer;
  padding: 0;
  transition: transform 0.2s ease, border 0.2s ease;
}

.color-swatch:hover {
  transform: scale(1.1);
}

.color-swatch.active {
  border: 2px solid black;
}

/* Mobile 2x2 grid & optional slider */
/* Mobile 2x2 grid & optional slider */
@media (max-width: 749px) {
  .new-arrived .grid.slider-enabled {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-left: 16px; /* відступ від краю */
    scroll-padding-left: 16px;
    gap: 16px;
  }

  .new-arrived .grid.slider-enabled .product-card {
    flex: 0 0 calc(50% - 8px); /* половина екрану мінус половина gap */
    scroll-snap-align: start;
  }

  .new-arrived .grid.slider-enabled .product-card:first-child {
    margin-left: 0; /* перший товар від краю */
  }

  /* Приховуємо скроллбар */
  .new-arrived .grid.slider-enabled::-webkit-scrollbar {
    display: none;
  }
  .new-arrived .grid.slider-enabled {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Кольори
  document.querySelectorAll(".color-swatch").forEach(button => {
    button.addEventListener("click", function() {
      const productCard = this.closest(".product-card");
      const img = productCard.querySelector(".product-image");
      productCard.querySelectorAll(".color-swatch").forEach(btn => btn.classList.remove("active"));
      this.classList.add("active");
      const newImage = this.getAttribute("data-image");
      if (newImage && img) img.src = newImage;
    });
  });

  // Slider only if enabled
  if({{ section.settings.enable_slider | json }}) {
    const sliders = document.querySelectorAll(".new-arrived .grid.slider-enabled");
    sliders.forEach(slider => {
      let isDown = false;
      let startX;
      let scrollLeft;

      slider.addEventListener("mousedown", (e) => {
        isDown = true;
        startX = e.pageX - slider.offsetLeft;
        scrollLeft = slider.scrollLeft;
      });

      slider.addEventListener("mouseleave", () => { isDown = false; });
      slider.addEventListener("mouseup", () => { isDown = false; });
      slider.addEventListener("mousemove", (e) => {
        if(!isDown) return;
        e.preventDefault();
        const x = e.pageX - slider.offsetLeft;
        const walk = (x - startX) * 2;
        slider.scrollLeft = scrollLeft - walk;
      });

      // Touch support
      let startTouchX = 0;
      let touchScrollLeft = 0;

      slider.addEventListener("touchstart", e => {
        startTouchX = e.touches[0].pageX - slider.offsetLeft;
        touchScrollLeft = slider.scrollLeft;
      });

      slider.addEventListener("touchmove", e => {
        const x = e.touches[0].pageX - slider.offsetLeft;
        const walk = (x - startTouchX) * 2;
        slider.scrollLeft = touchScrollLeft - walk;
      });
    });
  }
});
</script>